{% extends "base.html" %}

{% block title %}Sessions - Content Collector{% endblock %}

{% block content %}
<h1>Sessions</h1>

{% if not config.SCRAPER_SESSION_KEY %}
<div class="notification error" style="margin-bottom: 2rem;">
    <strong>Warning:</strong> No encryption key configured. Sessions cannot be saved securely.
    Set <code>SCRAPER_SESSION_KEY</code> environment variable to enable encrypted session storage.
</div>
{% endif %}

<article>
    <header>
        <h2>Upload Instagram Session</h2>
    </header>

    <div class="notification" style="margin-bottom: 2rem;">
        <strong>Privacy Notice:</strong> Sessions are encrypted with Fernet using your SCRAPER_SESSION_KEY.
        Only use cookies from throwaway Instagram accounts for scraping.
    </div>

    <form
        hx-post="{{ url_for('upload_session') }}"
        hx-encoding="multipart/form-data"
        hx-target="#upload-result"
        hx-swap="outerHTML"
    >
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <label for="cookies_file">Upload cookies.txt file:</label>
        <input
            type="file"
            id="cookies_file"
            name="cookies_file"
            accept=".txt"
            required
        >
        <small style="display: block; margin-top: 0.5rem; color: var(--pico-muted-color);">
            Export cookies from Instagram using a browser extension like "EditThisCookie".
            Make sure to include session cookies (sessionid, ds_user_id, mid, etc.).
        </small>
        <button type="submit" style="margin-top: 1rem;">Upload Session</button>
    </form>

    <div id="upload-result"></div>
</article>

{% if sessions %}
<article style="margin-top: 2rem;">
    <header>
        <h2>Saved Sessions</h2>
    </header>

    {% if sessions %}
        <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));">
            {% for session in sessions %}
            <div class="job-card">
                <div class="job-header">
                    <div>
                        <h3 class="job-title">
                            <span style="font-size: 1.5rem; margin-right: 0.5rem;">ðŸ”‘</span>
                            {{ session.username }}
                        </h3>
                        <div class="job-meta">
                            <span class="badge badge-instagram">session</span>
                            <span style="font-size: 0.75rem; color: var(--pico-muted-color);">
                                Created: {{ session.created_at[:19] }}Z
                            </span>
                        </div>
                    </div>
                    <div class="job-actions">
                        <form
                            method="post"
                            action="{{ url_for('delete_session', username=session.username) }}"
                            hx-post="{{ url_for('delete_session', username=session.username) }}"
                            hx-confirm="Are you sure you want to delete this session?"
                            hx-target="closest .job-card"
                            hx-swap="outerHTML"
                        >
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button type="submit" class="secondary" style="background: #ef4444; border-color: #ef4444;">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ðŸ”‘</div>
            <p>No sessions configured yet.</p>
            <p style="font-size: 0.875rem; color: var(--pico-muted-color); margin-top: 1rem;">
                Upload a cookies.txt file to create an encrypted session for Instagram scraping.
            </p>
        </div>
    {% endif %}
</article>
{% endif %}

<article style="margin-top: 2rem;">
    <header>
        <h2>How to Export Instagram Cookies</h2>
    </header>

    <ol>
        <li>Install a browser extension like <strong>EditThisCookie</strong> or <strong>GetCookies.txt</strong></li>
        <li>Log in to Instagram (use a <strong>throwaway account</strong>, never your personal account!)</li>
        <li>Click the extension and select "Export cookies" or similar</li>
        <li>Save the file as <code>cookies.txt</code></li>
        <li>Upload the file using the form above</li>
    </ol>

    <div class="notification" style="margin-top: 1rem;">
        <strong>Important:</strong> Sessions are encrypted using Fernet. Make sure <code>SCRAPER_SESSION_KEY</code>
        environment variable is set to the same value for future runs.
    </div>

    <div class="notification" style="margin-top: 1rem;">
        <strong>Security Warning:</strong> Never upload cookies from your personal Instagram account.
        Always use throwaway accounts for scraping. Instagram may ban accounts used for scraping.
    </div>
</article>

<article style="margin-top: 2rem;">
    <header>
        <h2>Environment Setup</h2>
    </header>

    <p>To enable session encryption, set the following environment variable:</p>

    <pre><code>export SCRAPER_SESSION_KEY=$(python -c "from cryptography.fernet import Fernet; import base64; print(Fernet.generate_key().decode())")</code></pre>

    <p>Or add to your <code>.env</code> file:</p>

    <pre><code>SCRAPER_SESSION_KEY=your-generated-key-here</code></pre>

    <p style="font-size: 0.875rem; color: var(--pico-muted-color);">
        Generate a secure Fernet key once and use it consistently. If you lose the key,
        encrypted sessions cannot be decrypted and will need to be recreated.
    </p>
</article>
{% endblock %}
