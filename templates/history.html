{% extends "base.html" %}

{% block title %}History - Content Collector{% endblock %}

{% block content %}
<h1>Download History</h1>

<form method="get" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
    <select name="platform">
        <option value="">All Platforms</option>
        <option value="youtube" {% if filters.platform == 'youtube' %}selected{% endif %}>YouTube</option>
        <option value="instagram" {% if filters.platform == 'instagram' %}selected{% endif %}>Instagram</option>
    </select>

    <select name="status">
        <option value="">All Statuses</option>
        <option value="pending" {% if filters.status == 'pending' %}selected{% endif %}>Pending</option>
        <option value="running" {% if filters.status == 'running' %}selected{% endif %}>Running</option>
        <option value="completed" {% if filters.status == 'completed' %}selected{% endif %}>Completed</option>
        <option value="failed" {% if filters.status == 'failed' %}selected{% endif %}>Failed</option>
        <option value="cancelled" {% if filters.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
    </select>

    <button type="submit">Filter</button>
    <a href="{{ url_for('history') }}" style="padding: 0.5rem 1rem; border: 1px solid var(--pico-border-color); border-radius: 4px; text-decoration: none; color: inherit;">Clear</a>
</form>

{% if jobs %}
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="border-bottom: 2px solid var(--pico-border-color);">
                <th style="text-align: left; padding: 0.75rem;">Date</th>
                <th style="text-align: left; padding: 0.75rem;">Platform</th>
                <th style="text-align: left; padding: 0.75rem;">Title / URL</th>
                <th style="text-align: left; padding: 0.75rem;">Status</th>
                <th style="text-align: left; padding: 0.75rem;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for job in jobs %}
                <tr style="border-bottom: 1px solid var(--pico-border-color);">
                    <td style="padding: 0.75rem; white-space: nowrap;">
                        {{ job.created_at[:10] if job.created_at else 'N/A' }}
                    </td>
                    <td style="padding: 0.75rem;">
                        <span class="badge badge-{{ job.platform }}">{{ job.platform }}</span>
                    </td>
                    <td style="padding: 0.75rem;">
                        {% if job.title %}
                            <div style="font-weight: 500;">{{ job.title }}</div>
                        {% endif %}
                        <a href="{{ job.url }}" target="_blank" style="font-size: 0.75rem; color: var(--pico-muted-color); word-break: break-all;">
                            {{ job.url[:60] }}{{ '...' if job.url|length > 60 else '' }}
                        </a>
                    </td>
                    <td style="padding: 0.75rem;">
                        <span class="badge badge-{{ job.status }}">{{ job.status }}</span>
                        {% if job.progress and job.progress > 0 and job.progress < 100 %}
                            <div style="font-size: 0.75rem; color: var(--pico-muted-color); margin-top: 0.25rem;">
                                {{ job.progress }}%
                            </div>
                        {% endif %}
                    </td>
                    <td style="padding: 0.75rem;">
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            {% if job.status == 'completed' %}
                                <a href="{{ url_for('browse', subpath=job.platform) }}" style="font-size: 0.875rem;">View</a>
                            {% endif %}

                            {% if job.status == 'failed' %}
                                <form
                                    method="post"
                                    action="{{ url_for('retry_job', job_id=job.id) }}"
                                    style="display: inline;"
                                    hx-post="{{ url_for('retry_job', job_id=job.id) }}"
                                    hx-target="closest tr"
                                    hx-swap="outerHTML"
                                >
                                    <button type="submit" style="font-size: 0.875rem;">Retry</button>
                                </form>
                            {% endif %}

                            {% if job.status in ['failed', 'cancelled', 'completed'] %}
                                <form
                                    method="post"
                                    action="{{ url_for('delete_job_route', job_id=job.id) }}"
                                    style="display: inline;"
                                    hx-delete="{{ url_for('delete_job_route', job_id=job.id) }}"
                                    hx-target="closest tr"
                                    hx-swap="outerHTML"
                                    hx-confirm="Are you sure you want to delete this job and its files?"
                                >
                                    <input type="hidden" name="_method" value="DELETE">
                                    <button type="submit" style="font-size: 0.875rem; color: #ef4444;">Delete</button>
                                </form>
                            {% endif %}
                        </div>

                        {% if job.error_message %}
                            <div class="error-message" style="margin-top: 0.5rem;">
                                {{ job.error_message }}
                            </div>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">ðŸ“‹</div>
        <p>No download history found.</p>
        {% if filters.platform or filters.status %}
            <p style="font-size: 0.875rem;">
                Try <a href="{{ url_for('history') }}">clearing the filters</a>.
            </p>
        {% else %}
            <p style="font-size: 0.875rem;">
                Start by <a href="{{ url_for('index') }}">downloading some content</a>.
            </p>
        {% endif %}
    </div>
{% endif %}
{% endblock %}
