name: Validate Config

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install uv package manager
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          uv sync

      - name: Create test .env file
        run: |
          cat > .env.test << 'EOF'
          FLASK_SECRET_KEY=test-secret-key-for-ci
          SCRAPER_DOWNLOAD_DIR=/tmp/test-downloads
          SCRAPER_DB_PATH=/tmp/test-scraper.db
          SCRAPER_MAX_CONCURRENT=2
          SCRAPER_IG_DELAY_MIN=5
          SCRAPER_IG_DELAY_MAX=10
          SCRAPER_DISK_WARN_MB=1024
          FLASK_HOST=127.0.0.1
          FLASK_PORT=5000
          EOF

      - name: Test Config class instantiation
        run: |
          # Set environment variables before importing the module
          export FLASK_SECRET_KEY='test-key'
          uv run python -c "
          import os
          from src.collector.config.settings import Config, get_config
          config = get_config()
          assert config.SECRET_KEY == 'test-key'
          # Check that download dir ends with 'downloads' (works for both relative and absolute paths)
          assert config.SCRAPER_DOWNLOAD_DIR.name == 'downloads' or str(config.SCRAPER_DOWNLOAD_DIR).endswith('downloads')
          assert config.SCRAPER_MAX_CONCURRENT == 2
          print('Config instantiation: OK')
          print(f'Download dir: {config.SCRAPER_DOWNLOAD_DIR}')
          print(f'Max concurrent: {config.SCRAPER_MAX_CONCURRENT}')
          "

      - name: Test validation rules
        run: |
          # Set environment variables before importing the module
          export FLASK_SECRET_KEY='test'
          export SCRAPER_MAX_CONCURRENT='5'
          export SCRAPER_IG_DELAY_MIN='10'
          export SCRAPER_IG_DELAY_MAX='20'
          uv run python -c "
          import os
          from src.collector.config.settings import Config

          # Verify environment variables are set
          assert os.environ['SCRAPER_MAX_CONCURRENT'] == '5'

          config = Config()
          assert config.SCRAPER_MAX_CONCURRENT == 5
          assert config.SCRAPER_IG_DELAY_MIN == 10.0
          assert config.SCRAPER_IG_DELAY_MAX == 20.0
          print('Validation rules: OK')
          "

      - name: Test environment variable loading
        run: |
          # Set environment variables before importing the module
          export FLASK_SECRET_KEY='test'
          export SCRAPER_DOWNLOAD_DIR='./custom_downloads'
          uv run python -c "
          import os
          from src.collector.config.settings import get_config
          config = get_config()
          # Check the path ends with the expected directory (handles both relative and absolute paths)
          assert config.SCRAPER_DOWNLOAD_DIR.name == 'custom_downloads' or str(config.SCRAPER_DOWNLOAD_DIR).endswith('custom_downloads')
          print('Environment variable loading: OK')
          "

      - name: Test Config.validate() method
        run: |
          # Set environment variables before importing the module
          export FLASK_SECRET_KEY='test-key'
          export FLASK_DEBUG='true'
          export SCRAPER_MAX_CONCURRENT='3'
          export SCRAPER_IG_DELAY_MIN='5'
          export SCRAPER_IG_DELAY_MAX='10'
          uv run python -c "
          import os
          from src.collector.config.settings import Config

          config = Config()
          errors = config.validate()
          assert len(errors) == 0, f'Expected no errors, got: {errors}'
          print('Config validation: OK')
          "

      - name: Verify .env.example exists
        run: |
          if [ -f .env.example ]; then
            echo '.env.example exists'
          else
            echo 'Warning: .env.example not found'
            echo 'Create .env.example with all required environment variables'
          fi
