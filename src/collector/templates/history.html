{% extends "base.html" %} {% block title %}History - Content Collector{% endblock %} {% block
content %}
<div class="page-header">
  <h1>Download History</h1>
  <p class="page-subtitle">
    Review completed and failed downloads, retry failures, and clean up old jobs.
  </p>
</div>

<section class="section-stack">
  <article class="panel">
    <header class="panel-header">
      <div>
        <h2>Filters</h2>
        <p class="helper-text">Select filters, apply once, and reset to return to all jobs.</p>
      </div>
    </header>

    <div class="panel-body">
      <form method="get" class="filters-row">
        <label>
          Platform
          <select name="platform">
            <option value="">All Platforms</option>
            <option value="youtube" {% if filters.platform="" ="youtube" %}selected{% endif %}>
              YouTube
            </option>
            <option value="instagram" {% if filters.platform="" ="instagram" %}selected{% endif %}>
              Instagram
            </option>
          </select>
        </label>

        <label>
          Status
          <select name="status">
            <option value="">All Statuses</option>
            <option value="pending" {% if filters.status="" ="pending" %}selected{% endif %}>
              Pending
            </option>
            <option value="running" {% if filters.status="" ="running" %}selected{% endif %}>
              Running
            </option>
            <option value="completed" {% if filters.status="" ="completed" %}selected{% endif %}>
              Completed
            </option>
            <option value="failed" {% if filters.status="" ="failed" %}selected{% endif %}>
              Failed
            </option>
            <option value="cancelled" {% if filters.status="" ="cancelled" %}selected{% endif %}>
              Cancelled
            </option>
          </select>
        </label>

        <div class="action-row filter-actions">
          <button type="submit" class="action-primary">Apply Filters</button>
          <a href="{{ url_for('pages.history') }}" class="action-secondary" role="button">Reset</a>
        </div>
      </form>
    </div>
  </article>

  {% if jobs %}
  <article class="panel">
    <header class="panel-header">
      <div>
        <h2>Results</h2>
        <p class="helper-text">{{ jobs|length }} job{{ 's' if jobs|length != 1 else '' }} shown</p>
      </div>
    </header>

    <div class="table-card">
      <table class="history-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Job</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for job in jobs %}
          <tr>
            <td data-label="Date">
              <p class="row-primary">
                {{ job.created_at.strftime('%Y-%m-%d') if job.created_at else 'N/A' }}
              </p>
              <p class="row-secondary">
                {{ job.created_at.strftime('%H:%M:%S') if job.created_at else '' }}
              </p>
            </td>
            <td data-label="Job">
              <div class="job-meta margin-bottom-sm">
                <span class="badge badge-{{ job.platform }}">{{ job.platform }}</span>
              </div>
              {% if job.title %}
              <p class="row-primary">{{ job.title }}</p>
              {% endif %}
              <a href="{{ job.url }}" target="_blank" class="row-secondary">
                {{ job.url[:72] }}{{ '...' if job.url|length > 72 else '' }}
              </a>
            </td>
            <td data-label="Status">
              <div class="status-stack">
                <span class="status-chip status-{{ job.status }}">{{ job.status }}</span>
                {% if job.progress and job.progress > 0 and job.progress < 100 %}
                <p class="job-meta-note">{{ job.progress }}% complete</p>
                {% endif %} {% if job.error_message %}
                <details>
                  <summary>View error details</summary>
                  <div class="error-message margin-top-md" style="max-width: 42ch">
                    {{ job.error_message }}
                  </div>
                </details>
                {% endif %}
              </div>
            </td>
            <td data-label="Actions">
              <div class="action-row">
                {% if job.status == 'completed' %}
                <a
                  href="{{ url_for('pages.browse', subpath=job.platform) }}"
                  class="action-primary"
                >
                  Open Files
                </a>
                {% endif %} {% if job.status == 'failed' %}
                <form
                  method="post"
                  action="{{ url_for('jobs.retry_job', job_id=job.id) }}"
                  hx-post="{{ url_for('jobs.retry_job', job_id=job.id) }}"
                  hx-target="closest tr"
                  hx-swap="outerHTML"
                >
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                  <button type="submit" class="action-primary">Retry</button>
                </form>
                {% endif %}
              </div>

              {% if job.status in ['failed', 'cancelled', 'completed'] %}
              <div class="action-row margin-top-md">
                <form
                  method="post"
                  action="{{ url_for('jobs.delete_job_route', job_id=job.id) }}"
                  hx-delete="{{ url_for('jobs.delete_job_route', job_id=job.id) }}"
                  hx-target="closest tr"
                  hx-swap="outerHTML"
                  hx-confirm="Are you sure you want to delete this job and its files?"
                >
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                  <input type="hidden" name="_method" value="DELETE" />
                  <button type="submit" class="action-danger">Delete</button>
                </form>
              </div>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </article>
  {% else %}
  <article class="panel">
    <div class="empty-state">
      <div class="empty-state-icon">ðŸ“‹</div>
      <p>No download history found.</p>
      {% if filters.platform or filters.status %}
      <p class="helper-text">No jobs match the active filters.</p>
      <div class="action-row justify-center margin-top-md">
        <a href="{{ url_for('pages.history') }}" role="button" class="action-secondary">
          Clear Filters
        </a>
      </div>
      {% else %}
      <p class="helper-text">Create your first download job from the dashboard.</p>
      <div class="action-row justify-center margin-top-md">
        <a href="{{ url_for('pages.index') }}" role="button" class="action-primary">
          Go to Dashboard
        </a>
      </div>
      {% endif %}
    </div>
  </article>
  {% endif %}
</section>
{% endblock %}
